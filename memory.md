# MEMORY EXERCISES

## Problems on Memory Management (Mythili Vutukuru, IIT Bombay)
1. Provide one advantage of using the slab allocator in Linux to allocate kernel objects, instead of
simply allocating them from a dynamic memory heap.
My answer: 
```sh
- No memory is wasted by degramentation due to each objects in slab is associated with the cache. 
- Memory request may be fast
```
Solution: 
> *A slab allocator is fast because memory is preallocated. Further, it avoids fragmentation of
kernel memory*

2. In a 32-bit architecture machine running Linux, for every physical memory address in RAM, there
are at least 2 virtual addresses pointing to it. That is, every physical address is mapped at least
twice into the virtual address space of some set of processes. [T/F]
```sh
False 
```
Solution: 
> F (this may be true of simple OS like xv6 studied in class, but not generally true)

3. Consider a system with N bytes of physical RAM, and M bytes of virtual address space per process. Pages and frames are K bytes in size. Every page table entry is P bytes in size, accounting
for the extra flags required and such. Calculate the size of the page table of a process.
```sh
N = M * P / K  
```
Solution: 
> M/K * P 

4. The memory addresses generated by the CPU when executing instructions of a process are called
logical addresses. [T/F]
```sh
False ====> WRONG! 
```
Solution:
> True

5. When a C++ executable is run on a Linux machine, the kernel code is part of the executable
generated during the compilation process. [T/F]
```sh
False.  
```
Solution:
> False (it is only part of the virtual address space of the running process)

6. When a C++ executable is run on a Linux machine, the kernel code is part of the virtual address
space of the running process. [T/F]
```sh
True
```
Solution:
> True

7. Consider a Linux-like OS running on x86 Intel CPUs. Which of the following events requires
the OS to update the page table pointer in the MMU (and flush the changes to the TLB)? Answer
“update” or “no update”.
(a) A process moves from user mode to kernel mode.
```sh
No update
```
Solution: 
> No update
(b) The OS switches context from one process to another.
```sh
Update 
```
> Update

8. Consider a process that has just forked a child. The OS implements a copy-on-write fork. At the
end of the fork system call, the OS does not perform a context switch and will return back to the
user mode of the parent process. Now, which of the following entities are updated at the end of a
successful implementation of the fork system call? Answer “update” or “no update”.
(a) The page table of the parent process.
```sh
No update ====> WRONG!!!
```
>  update because the parent’s pages must be marked read-only
(b) The page table information in the MMU and the TLB.
```sh
Update 
```
> update because the parent’s pages must be marked read-only.

9. A certain page table entry in the page table of a process has both the valid and present bits set.
Describe what happens on a memory access to a virtual address belonging to this page table entry.
(a) What happens at the TLB? (hit/miss/cannot say)
```sh
cannot say 
```
> cannot say
(b) Will a page fault occur? (yes/no/cannot say)
```sh
No, due to the present bits set. 
```
> No

10. A certain page table entry in the page table of a process has the valid bit set but the present bit
unset. Describe what happens on a memory access to a virtual address belonging to this page table
entry.
(a) What happens at the TLB? (hit/miss/cannot say)
```sh
Miss. Due to the present bit unset.  
```
> Miss 
(b) Will a page fault occur? (yes/no/cannot say)
```sh
Yes. Like above 
```
> Yes. 

11. Consider the page table entries within the page table of a process that map to kernel code/data
stored in RAM, in a Linux-like OS studied in class.
(a) Are the physical addresses of the kernel code/data stored in the page tables of various process
always the same? (yes/no/cannot say)
```sh
No. ===> WRONG!!!!
```
> yes, because there is only one copy of kernel code in RAM
(b) Does the page table of every process have page table entries pointing to the kernel code/data?
(yes/no/cannot say)
```sh
cannot say. ===> WRONG!!!!
```
> yes, because every process needs to run kernel code in kernel mode

12. Consider a process P running in a Linux-like operating system that implements demand paging.
The page/frame size in the system is 4KB. The process has 4 pages in its heap. The process stores
an array of 4K integers (size of integer is 4 bytes) in these 4 pages. The process then proceeds to
access the integers in the array sequentially. Assume that none of these 4 pages of the heap are
initially in physical memory. The memory allocation policy of the OS allocates only 3 physical
frames at any point of time, to the store these 4 pages of the heap. In case of a page fault and all
3 frames have been allocated to the heap of the process, the OS uses a LRU policy to evict one of
these 4 pages to make space for the new page. Approximately what fraction of the 4K accesses to
array elements will result in a page fault?
(a) Almost 100
(b) Approximately 25
(c) Approximately 75
(d) Approximately 0.1
```sh
(B) ===> WRONG!!!!
```
> (D)

13. Given below are descriptions of different entries in the page table of a process, with respect to
which bits are set and which are not set. Accessing which of the page table entries below will
always result in the MMU generating a trap to the OS during address translation?
(a) Page with both valid and present bits set
(b) Page with valid bit set but present bit unset
(c) Page with valid bit unset
(d) Page with valid, present, and dirty bits set
```sh
(B) ===> WRONG!!!!
```
> (B), (C)

14. Which of the following statements is/are true regarding the memory image of a process?
(a) Memory for non-static local variables of a function is allocated on the heap dynamically at
run time
(b) Memory for arguments to a function is allocated on the stack dynamically at run time
(c) Memory for static and global variables is allocated on the stack dynamically at run time
(d) Memory for the argc, argv arguments to the main function is allocated in the code/data
section of the executable at compile time
```sh
(A), (D) ===> WRONG!!!!
```
> (B)

15. Consider a process P in a Linux-like operating system that implements demand paging. Which of
the following pages in the page table of the process will have the valid bit set but the present bit
unset?
(a) Pages that have been used in the past by the process, but were evicted to swap space by the
OS due to memory pressure
(b) Pages that have been requested by the user using mmap/brk/sbrk system calls, but have not
yet been accessed by the user, and hence not allocated physical memory frames by the OS
(c) Pages corresponding to unused virtual addresses in the virtual address space of the process
(d) Pages with high virtual addresses mapping to OS code and data
```sh
(B) ===> WRONG!!!!
```
> (A), (B)

16. Consider a process P in a Linux-like operating system that implements demand paging. For a
particular page in the page table of this process, the valid and present bits are both set. Which of
the following are possible outcomes that can happen when the CPU accesses a virtual address in
this page of the process? Select all outcomes that are possible.
(a) TLB hit (virtual address found in TLB)
(b) TLB miss (virtual address not found in TLB)
(c) MMU walks the page table (to translate the address)
(d) MMU traps to the OS (due to illegal access)
```sh
(A), (B) ===> WRONG!!!!
```
> (a), (b), (c), (d)

17. Consider a process P in a Linux-like operating system that implements demand paging using the
LRU page replacement policy. You are told that the i-th page in the page table of the process has
the accessed bit set. Which of the following statements is/are true?
(a) This bit was set by OS when it allocated a physical memory frame to the page
(b) This bit was set by MMU when the page was accessed in the recent past
(c) This page is likely to be evicted by the OS page replacement policy in the near future
(d) This page will always stay in physical memory as long as the process is alive
```sh
(d) ===> WRONG!!!!
```
> (b)

18. Which of the following statements is/are true regarding the functions of the OS and MMU in a
modern computer system?
(a) The OS sets the address of the page table in a CPU register accessible to the MMU every
time a new process is created in the system
(b) The OS sets the address of the page table in a CPU register accessible to the MMU every
time a new process is context switched in by the CPU scheduler
(c) MMU traps to OS every time an address is not found in the TLB cache
(d) MMU traps to OS every time it cannot translate an address using the page table available to
it
```sh
(b), (d)
```
> (b), (d)

19. Consider a modern computer system using virtual addressing and translation via MMU. Which of
the following statements is/are valid advantages of using virtual addressing as opposed to directly
using physical addresses to fetch instructions and data from main memory?
(a) One does not need to know the actual addresses of instructions and data in main memory
when generating compiled executables.
(b) One can easily provide isolation across processes by limiting the physical memory that is
mapped into the virtual address space of a process.
(c) Using virtual addressing allows us to hide the fact that user’s memory is allocated noncontiguously, and helps provide a simplified view to the user.
(d) Memory access using virtual addressing is faster than directly accessing memory using physical addresses.
```sh
(b), (c) ===> WRONG!!!!
```
> (a), (b), (c)

20. Consider a process running on a system with a 52-bit CPU (i.e., virtual addresses are 48 bits in
size). The system has a physical memory of 8GB. The page size in the system is 4KB, and the
size of a page table entry is 4 bytes. The OS uses hierarchical paging. Which of the following
statements is/are true? You can assume 2^10 = 1K, 2^20 = 1M, and so on.
(a) We require a 4-level page table to keep track of the virtual address space of a process.
(b) We require a 5-level page table to keep track of the virtual address space of a process.
(c) The most significant 9 bits are used to index into the outermost page directory by the MMU
during address translation.
(d) The most significant 40 bits of a virtual address denote the page number, and the least significant 12 bits denote the offset within a page.
```sh
...
```
> (a), (d)

21. Consider the following line of code in a function of a process.
int *x = (int *)malloc(10 * sizeof(int));
When this function is invoked and executed:
(a) Where is the memory for the variable x allocated within the memory image of the process?
(stack/heap)
```sh
stack 
```
> stack 
(b) Where is the memory for the 10 integer variables allocated within the memory image of the
process? (stack/heap)
```sh
heap 
```
> heap 

22. Consider an OS that is not using a copy-on-write implementation for the fork system call. A
process P has spawned a child C. Consider a virtual address v that is translated to physical address
Ap(v) using the page table of P, and to Ac(v) using the page table of C.
(a) For which virtual addresses v does the relationship Ap(v) = Ac(v) hold?
```sh

```
(b) For which virtual addresses v does the relationship Ap(v) = Ac(v) not hold?
```sh

```

23. Consider a system with paging-based memory management, whose architecture allows for a 4GB
virtual address space for processes. The size of logical pages and physical frames is 4KB. The
system has 8GB of physical RAM. The system allows a maximum of 1K (=1024) processes to run
concurrently. Assuming the OS uses hierarchical paging, calculate the maximum memory space
required to store the page tables of all processes in the system. Assume that each page table entry
requires an additional 10 bits (beyond the frame number) to store various flags. Assume page table
entries are rounded up to the nearest byte. Consider the memory required for both outer and inner
page tables in your calculations.
```sh

```

24. Consider a simple system running a single process. The size of physical frames and logical
pages is 16 bytes. The RAM can hold 3 physical frames. The virtual addresses of the process
are 6 bits in size. The program generates the following 20 virtual address references as it runs
on the CPU: 0, 1, 20, 2, 20, 21, 32, 31, 0, 60, 0, 0, 16, 1, 17, 18,
32, 31, 0, 61. (Note: the 6-bit addresses are shown in decimal here.) Assume that the
physical frames in RAM are initially empty and do not map to any logical page.
(a) Translate the virtual addresses above to logical page numbers referenced by the process. That
is, write down the reference string of 20 page numbers corresponding to the virtual address
accesses above. Assume pages are numbered starting from 0, 1, ...
(b) Calculate the number of page faults genrated by the accesses above, assuming a FIFO page
replacement algorithm. You must also correctly point out which page accesses in the reference string shown by you in part (a) are responsible for the page faults.
(c) Repeat (b) above for the LRU page replacement algorithm.
(d) What would be the lowest number of page faults achievable in this example, assuming an
optimal page replacement algorithm were to be used? Repeat (b) above for the optimal
algorithm.
```sh

```

25.  Consider a system with only virtual addresses, but no concept of virtual memory or demand paging. Define total memory access time as the time to access code/data from an address in physical
memory, including the time to resolve the address (via the TLB or page tables) and the actual
physical memory access itself. When a virtual address is resolved by the TLB, experiments on a
machine have empirically observed the total memory access time to be (an approximately constant
value of) th. Similarly, when the virtual address is not in the TLB, the total memory access time
is observed to be tm. If the average total memory access time of the system (averaged across
all memory accesses, including TLB hits as well as misses) is observed to be tx, calculate what
fraction of memory addresses are resolved by the TLB. In other words, derive an expression for
the TLB hit rate in terms of th, tm, and tx. You may assume tm > th.
```sh

```

26. 4. Consider a system with a 6 bit virtual address space, and 16 byte pages/frames. The mapping
from virtual page numbers to physical frame numbers of a process is (0,8), (1,3), (2,11), and
(3,1). Translate the following virtual addresses to physical addresses. Note that all addresses are
in decimal. You may write your answer in decimal or binary.
(a) 20
(b) 40
```sh

```
27. Consider a system with several running processes. The system is running a modern OS that uses
virtual addresses and demand paging. It has been empirically observed that the memory access
times in the system under various conditions are: t1 when the logical memory address is found in
TLB cache, t2 when the address is not in TLB but does not cause a page fault, and t3 when the
address results in a page fault. This memory access time includes all overheads like page fault
servicing and logical-to-physical address translation. It has been observed that, on an average,
10% of the logical address accesses result in a page fault. Further, of the remaining virtual address accesses, two-thirds of them can be translated using the TLB cache, while one-third require
walking the page tables. Using the information provided above, calculate the average expected
memory access time in the system in terms of t1,t2, and t3.
```sh

```

28. Consider a system where each process has a virtual address space of 2
v bytes. The physical address
space of the system is 2
p bytes, and the page size is 2
k bytes. The size of each page table entry is
2
e bytes. The system uses hierarchical paging with l levels of page tables, where the page table
entries in the last level point to the actual physical pages of the process. Assume l ≥ 2. Let v0
denote the number of (most significant) bits of the virtual address that are used as an index into
the outermost page table during address translation.
(a) What is the number of logical pages of a process?
(b) What is the number of physical frames in the system?
(c) What is the number of PTEs that can be stored in a page?
(d) How many pages are required to store the innermost PTEs?
(e) Derive an expression for l in terms of v, p, k, and e.
(f) Derive an expression for v0 in terms of l, v, p, k, and e.
```sh

```
